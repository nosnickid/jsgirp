<!DOCTYPE html>
<html>
<head>
    <title>Javascript Box 2D Girp</title>
    <link href="css/ui-lightness/jquery-ui-1.8.21.custom.css" media="screen" rel="stylesheet" />
    <link href="css/player_editor.css" media="screen" rel="stylesheet" />
</head>
<body>


<h1>JS reinterpretation of GIRP</h1>

<canvas id="display" width="800" height="600" style="background: black; border: 1px solid black;"></canvas>



<script src="js/jquery-1.7.2.min.js" type="text/javascript"></script>
<script src="js/jquery-ui-1.8.21.custom.min.js" type="text/javascript"></script>
<script src="js/Box2dWeb-2.1.a.3.js" type="text/javascript" ></script>
<script src="js/polyfill.requestAnimationFrame.js" type="text/javascript"></script>
<script src="js/draw_world.js" type="text/javascript" ></script>
<script src="girp.js" type="text/javascript"></script>

<script type="text/javascript">
    var girp;

    var canvas = $("#display")[0];
    var ctx = canvas.getContext('2d');
    var canvasWidth = canvas.width;
    var canvasHeight = canvas.height;
    var timeout;
    var playerDef;

    function init() {
        playerDef = new GirpPlayerDef();
    }

    function resetGame() {
        if (girp) girp.stop();

        girp = new GirpGame();
        girp.initWorld(playerDef);
        girp.bindInput(window);
        girp.setRenderCallback(draw);
    }

    function draw() {
        ctx.clearRect(-canvasWidth, -canvasHeight, 2*canvasWidth, 2*canvasHeight);
        //drawVector(-100, 0, 100, 0, "#ff0000");
        //drawVector(0, -100, 0, 100, "#00ff00");

        window.drawWorld(girp.world);
    }

    function dumpPlayerDefJson() {
        $('#playerDefJson').text(JSON.stringify(playerDef));
    }

    function onPlayerFieldChange() {
        var field;
        field = $(this).data('player-field');

        playerDef[field] = parseFloat($(this).val());
        resetGame();
        draw();
        dumpPlayerDefJson();
    }

    function bindUiFromPlayerDef() {
        var fieldList = $('#playerDefEditorRows');

        fieldList.empty();

        $.each(playerDef, function(field, value) {
            var row, label, control;
            var title = field;
            title = title.replace(/([A-Z])/g, " $1");
            title = title.charAt(0).toUpperCase() + title.slice(1);

            row = $('<li></li>').addClass('row');
            label = $('<label />').text(title).attr('for', 'playerDef' + field);
            control = $('<input />')
                .attr('type', 'number')
                .attr('id', 'playerDef' + field)
                .data('player-field', field)
                .val(value)
                .on('change', onPlayerFieldChange);


            row.append(label).append(control);

            fieldList.append(row);
        });
    }

    $(function() {
        /* dodgy call into our dodgy renderer. */
        window.setRenderContext(ctx);

        init();
        resetGame();
        girp.start();
        dumpPlayerDefJson();

        d_velocityVector = 1;

        bindUiFromPlayerDef();

        $('#loadPlayerDefFromJSON').on('click', function() {
            playerDef = JSON.parse($('#playerDefJson').val());
            bindUiFromPlayerDef();
            resetGame();
            draw();
        });
    });

</script>

<div style="cursor: pointer;" onclick="resetGame(); girp.start();">go</div>
<div style="cursor: pointer;" onclick="resetGame(); draw()">reset</div>

<input type="checkbox" id="vel" onchange="window.d_velocityVector = this.checked;"><label for="vel">draw velocity vectors</label>

<div id="player_editor">
    <h1>Player Editor</h1>

    <ul id="playerDefEditorRows">

    </ul>

    <div class="row">
        <div>
            <label for="playerDefJson">As JSON:</label>
            <textarea id="playerDefJson" cols="50" rows="15"></textarea>
        </div>
        <div>
            <label for="loadPlayerDefFromJSON">&nbsp;</label>
            <button id="loadPlayerDefFromJSON">import JSON</button>
        </div>
    </div>


</div>

</body>
</html>